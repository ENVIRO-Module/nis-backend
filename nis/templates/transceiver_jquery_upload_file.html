<!doctype html>

<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
    <title>Magic Box - NIS prototype</title>

    <!-- Drag and drop and Upload -->
    <link href="http://hayageek.github.io/jQuery-Upload-File/4.0.10/uploadfile.css" rel="stylesheet">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="http://hayageek.github.io/jQuery-Upload-File/4.0.10/jquery.uploadfile.min.js"></script>

    <!-- Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.fileDownload/1.4.2/jquery.fileDownload.min.js"></script>

    <script src="{{ url_for('static', filename='js/FileSaver.min.js') }}"></script>

    <!-- Bootstrap 3 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" />

    <!-- Specific -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='magic-nis.css') }}" />
    <script src="{{ url_for('static', filename='magic-nis.js') }}"></script>

    <script>
        function initializeFileUploader()
        {
            $(".ajax-file-upload-container").remove();
            $("#fileuploader").uploadFile({
                url:"/magic-nis/file-transmuter",
                multiple:false,
                //dragDropStr: "Drop an Excel file here",
                onSubmit:function(files)
                {
                    var img_url = "{{ url_for('static', filename='images/loading_spinner.gif') }}";
                    $('#myDiv').html("<img id='load_spinner' align=\"center\" src=\""+ img_url +"\">");
                },
                onSuccess:function(files,data,xhr,pd)
                {
                    var alternativa = 1;
                    if (alternativa==0)
                    {
                        var res = data.split("/");
                        window.file_name = res[res.length-1];

                        var oReq = new XMLHttpRequest();
                        oReq.addEventListener("load", function(oEvent) {
                            var arrayBuffer = oReq.response;
                            var blob = new Blob([arrayBuffer]);
                            if (arrayBuffer)
                            {
                                var byteArray = new Uint8Array(arrayBuffer);
                                saveAs(blob, window.file_name);
                                $('#myDiv').html("");
                                initializeFileUploader();
                            }
                        }
                        );
                        oReq.addEventListener("error", function(oEvent){
                            $('#myDiv').html("");
                            initializeFileUploader();
                        }
                        );
                        oReq.open("GET", data, true);
                        oReq.responseType = "arraybuffer";
                        oReq.send(null);
                    }
                    else
                    {
                        $.fileDownload(data)
                            .done(function() {
                                $('#myDiv').html("");
                                initializeFileUploader();
                            }
                            )
                            .fail(function() {
                                $('#myDiv').html("");
                                initializeFileUploader();
                            }
                            );
                    }
                    // $("#eventsmessage").html($("#eventsmessage").html()+"<br/>Success for: "+JSON.stringify(data));

                },
                fileName:"test"
            });
        }
        $(function()
        {
            initializeFileUploader();
        });
    </script>

</head>

<body>

<div class="container-full">
    <div class="row">
        <img src="{{ url_for('static', filename='images/4_logo_magic_fondo trasparente_rgb.png') }}" class="col-lg-1 img-rounded">
        <div class="row col-lg-11">
            <div class="col-lg-10 v-center">
                <h1>Magic Box</h1>
                <p class="lead">Drop an Excel file to be processed</p>
                <div class="col-lg-6" id="fileuploader"></div>
                <div id="myDiv"></div>

            </div>
            <div class="row col-lg-10">
                <div class="col-lg-6">
                    <br>
                    <p class="lead">
                        <a href="/magic-nis/template_file/1">Template</a>
                        <!-- Magic logo in "ASCII art" -->
                        <b style="color:#CAC812">&gt;</b><b style="color:#1E4081">|</b><b style="color:#F2991C">&lt;</b>
                        <a href="/magic-nis/template_file/2">Example</a>
                    </p>
                </div>
            </div>
        </div>

    </div> <!-- /row -->

</div> <!-- /container full -->

</body>


</html>